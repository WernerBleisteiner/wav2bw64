
{% extends "base.html" %}
{% block title %}WAV File Info{% endblock %}
{% block body %}
  <script src="https://unpkg.com/wavesurfer.js"></script>

  <h1>WAV File Info: {{ filename }}</h1>
  {% if wav_info %}
    <p>Channels: {{wav_info["Channels"]}}</p>
    <p>File Format: {{wav_info["File Format"]}}</p>
    <p>Bit Depth: {{wav_info["Bit Depth"]}}</p>
    <p>bext Chunk: {{wav_info["bext chunk"]}}</p>
  {% endif%}
  <button type="button" class="btn btn-large btn-info" id="showWaveBtn" onclick="showWave();">Render Waveform</button>
  <div id="waveform"></div>
  <button type="button" class="btn btn-large btn-success" data-action="play">Play/Pause</button>
  <script>
  var wavesurfer;
  let waveFormRendered = false;
    function showWave(){
      if (waveFormRendered === false){
        wavesurfer = WaveSurfer.create({
          container: '#waveform',
          backend: 'MediaElement',
          waveColor: 'violet',
          progressColor: 'purple',
          minPxPerSec: 30,
          scrollParent: true,
          mediaControls: true,
          partialRender: true,
          splitChannels: true
        });
        fetch('/' + '{{ jsonpath }}')
        .then(response => {
            if (!response.ok) {
                throw new Error("HTTP error " + response.status);
            }
            return response.json();
        })
        .then(peaks => {
            console.log('loaded peaks! sample_rate: ' + peaks.sample_rate);
            // load peaks into wavesurfer.js
            wavesurfer.load("/" + "{{ path }}", peaks.data);
        })
        .catch((e) => {
            console.error('error', e);
        });

        //wavesurfer.load("/" + "{{ path }}");
        document
          .querySelector('[data-action="play"]')
          .addEventListener('click', wavesurfer.playPause.bind(wavesurfer));
      }
      waveFormRendered = true;
    }
  </script>
{% endblock %}
